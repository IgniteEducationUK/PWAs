<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ignite Education - Genre Writer</title>
    <!-- PWA Manifest link -->
    <link rel="manifest" href="manifest.json">
    
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom styles for a polished look */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f4f7f9;
        }
        .container-card {
            max-width: 800px;
            margin: 2rem auto;
            padding: 2rem;
            background-color: #ffffff;
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 0 10px -5px rgba(0, 0, 0, 0.04);
            transition: transform 0.3s ease;
        }
        .help-modal-overlay {
            visibility: hidden;
            opacity: 0;
            transition: opacity 0.3s, visibility 0.3s;
        }
        .help-modal-overlay.open {
            visibility: visible;
            opacity: 1;
        }
        .help-modal-content {
            transform: translateY(-20px);
            transition: transform 0.3s ease;
        }
        .help-modal-overlay.open .help-modal-content {
            transform: translateY(0);
        }
        .btn-primary {
            transition: background-color 0.2s, transform 0.1s;
        }
        .btn-primary:hover {
            background-color: #d13a00; /* Darker orange */
        }
        .btn-primary:active {
            transform: scale(0.98);
        }
    </style>
</head>
<body class="min-h-screen p-4 sm:p-8">

    <!-- Main Application Card -->
    <div class="container-card rounded-xl">
        <header class="mb-8 border-b pb-4">
            <h1 class="text-4xl font-extrabold text-gray-900 text-center tracking-tight">
                <span class="text-orange-600">Ignite</span> Education
            </h1>
            <p class="text-center text-gray-500 mt-2">Genre Continuation Tool</p>
        </header>

        <!-- Input Controls -->
        <section class="space-y-6">
            <div class="flex flex-col sm:flex-row gap-4 items-center">
                <label for="genre-select" class="block text-lg font-medium text-gray-700 sm:w-1/3">
                    Choose a Genre:
                </label>
                <select id="genre-select" class="mt-1 block w-full sm:w-2/3 pl-3 pr-10 py-3 text-base border-gray-300 focus:outline-none focus:ring-orange-500 focus:border-orange-500 sm:text-lg rounded-lg shadow-sm cursor-pointer">
                    <option value="" disabled selected>-- Select a writing style --</option>
                </select>
            </div>

            <div class="flex flex-col sm:flex-row gap-4 pt-4">
                <button id="generate-button" disabled class="flex-1 btn-primary bg-orange-500 hover:bg-orange-600 text-white font-semibold py-3 px-6 rounded-lg shadow-md disabled:opacity-50 disabled:cursor-not-allowed text-lg">
                    Generate Continuation Paragraph
                </button>
                <button id="help-button" disabled class="w-full sm:w-auto bg-gray-200 hover:bg-gray-300 text-gray-800 font-semibold py-3 px-6 rounded-lg shadow-md disabled:opacity-50 disabled:cursor-not-allowed text-lg">
                    Help!
                </button>
            </div>
        </section>

        <!-- Output Area -->
        <section class="mt-10">
            <h2 class="text-2xl font-semibold text-gray-800 mb-4 border-b pb-2">Generated Text</h2>
            <div id="output-area" class="min-h-[120px] p-6 bg-gray-50 border border-gray-200 rounded-lg text-gray-700 leading-relaxed text-base italic transition-all duration-300">
                Select a genre and click 'Generate' to get a paragraph of 50-100 words to continue from.
            </div>
            <div id="loading-indicator" class="hidden text-center mt-4">
                <div class="inline-block h-8 w-8 animate-spin rounded-full border-4 border-solid border-orange-500 border-r-transparent align-[-0.125em] motion-reduce:animate-[spin_1.5s_linear_infinite]" role="status">
                    <span class="!absolute !-m-px !h-px !w-px !overflow-hidden !whitespace-nowrap !border-0 !p-0 ![clip:rect(0,0,0,0)]">Loading...</span>
                </div>
                <p class="text-gray-500 text-sm mt-2">Generating content...</p>
            </div>
            <div id="error-message" class="hidden text-red-600 font-medium text-sm mt-4 p-3 bg-red-50 border border-red-200 rounded-lg">
                <!-- Error messages will appear here -->
            </div>
        </section>
    </div>

    <!-- Help Modal/Dialog -->
    <div id="help-modal-overlay" class="help-modal-overlay fixed inset-0 bg-gray-900 bg-opacity-70 flex justify-center items-center z-50 p-4">
        <div id="help-modal-content" class="help-modal-content bg-white p-8 rounded-xl shadow-2xl w-full max-w-md">
            <h3 class="text-2xl font-bold mb-4 text-gray-800 border-b pb-2">Genre Elements: <span id="help-genre-title" class="text-orange-600"></span></h3>
            <ul id="help-suggestions-list" class="list-disc ml-5 space-y-2 text-gray-600 text-base">
                <!-- Suggestions will be injected here -->
            </ul>
            <button onclick="document.getElementById('help-modal-overlay').classList.remove('open')" class="mt-6 w-full bg-orange-500 text-white font-semibold py-2 rounded-lg hover:bg-orange-600 transition duration-150">
                Got It!
            </button>
        </div>
    </div>

    <script type="module">
        
        // SECURE PROXY ENDPOINT: All API calls are now routed through Cloud Run.
        const proxyUrl = "https://pwa-contpara-958819967973.europe-west1.run.app"; 
        
        // --- Core Application Logic ---

        const genreMap = {
            'adventure': 'Adventure',
            'sci-fi': 'Sci-Fi',
            'horror': 'Horror',
            'fairy/traditional tale': 'Fairy/Traditional Tale',
            'comedy': 'Comedy',
            'tragedy': 'Tragedy',
            'report': 'Report',
            'diary': 'Diary',
            'instructions': 'Instructions'
        };

        // FALLBACK TEXTS: Used if the API fails after all retry attempts.
        const fallbackParagraphs = {
            'adventure': "The rusted iron gate creaked open, revealing a path choked with thick jungle growth. Elias checked his compass, noting that the magnetic field here was completely unstable—a problem they hadn't anticipated. He tightened the straps on his rucksack, the silence broken only by the distant, rhythmic drumming of an unknown tribe. The map promised a hidden city just beyond the ridge, but getting there would require crossing the ravine, and the old rope bridge looked dangerously frayed. He took a deep, steadying breath and began the ascent.",
            'sci-fi': "Above the neon-slicked megacity of Neo-Kyoto, Sergeant Kaelen watched the cargo bay doors cycle open. Her mission: retrieve the data module from the downed drone before the Syndicate arrived. The airlock hissed, venting thin, recycled oxygen into the vacuum. The gravity boots engaged with a solid *thunk*, and she began her careful walk across the hull, the stars a brutal, unforgiving backdrop. Her comms crackled with static, a warning she couldn't quite decipher, just as the first shadow flitted across the periphery of her reinforced visor.",
            'horror': "The basement air was thick and cold, smelling perpetually of damp earth and something metallic, like old pennies. Every floorboard above groaned as the house settled, but this sound was different—a wet, dragging noise coming from behind the sealed pantry door. Sarah’s breath hitched in her throat, her torch beam dancing wildly over the grime-caked stone. She told herself it was just the pipes, just the wind, but the scratching intensified, rhythmic and deliberate, like something trying to claw its way out. The rusty latch rattled once more.",
            'fairy/traditional tale': "In the heart of the Whisperwood stood a tiny cottage roofed with moss, where lived a young girl named Elara who possessed a gift for weaving sunbeams into golden thread. One morning, the ancient, crooked clock struck thirteen, and a small, mischievous gnome appeared upon the windowsill, his beard tangled with dew and clover. He offered Elara three glittering dew-drops in exchange for her silence concerning the location of the Sunstone of the Trolls. Elara knew the price of silence was often too high, yet the dew-drops shimmered with a terrible, sweet temptation.",
            'comedy': "Professor Plumb was already having a disastrous Tuesday, largely due to accidentally gluing his own hand to his coffee mug, when the automated lecture system decided to introduce a surprise fireworks display. The resulting chaos saw the Head of Department, Dr. Beaker, attempting to extinguish a burning whiteboard using a novelty water pistol filled with lukewarm tea. Plumb sighed, tried to gesture towards the fire alarm with his free, non-mugged hand, and instead accidentally elbowed a delicate anatomical model of a human ear off the desk. He knew he should have stayed in bed.",
            'tragedy': "When the letter arrived, it was sealed with the familiar crest of the Duke, yet it brought not honour but ashes. Marcus read the short decree twice, his hands trembling as the fragile parchment threatened to crumble. He had sacrificed everything—his family's wealth, his sister's dowry, his own reputation—all for this one, singular venture, and now, it was over. The decree stated simply that the ships, his only hope of recouping the losses, had been lost to a rogue storm off the coast of Volterra. He looked out at the darkening sea, knowing the path to redemption was now closed forever.",
            'report': "A full analysis of the structural degradation of Test Subject 4-B's polymer shell indicates a catastrophic failure rate commencing at 14:03 GMT on 2025-09-30. The primary cause is attributed to an unexpected thermodynamic shock within the reaction core (see Appendix A for thermal graphs). Specifically, the lack of adequate phase-change coolant resulted in a plasma containment breach, leading to the rapid disintegration of all exterior housing layers. Recommendations include a complete redesign of the coolant loop geometry and recalibration of emergency venting protocols before human testing is initiated.",
            'diary': "30 September: I can't believe how strange today was. First, Mrs Davies swore the entire class to secrecy about the new drama club uniforms (why do they look like 1980s aerobics gear?) and then Jake actually asked me for help with his History essay. He never asks anyone for help. I probably sounded completely useless. I keep replaying the conversation in my head, wondering if I should have just offered to write it for him. This whole day feels like one giant, awkward social experiment, and I really need to find out what tomorrow's homework is.",
            'instructions': "Step 4: Secure the main structural column using the provided hex bolts (A-6). Ensure the alignment tab (located at the column base) is firmly seated in the floor channel before tightening. Use a torque wrench to apply 150 Newton-meters of pressure to each bolt. **Caution:** Overtightening will shear the threads. Step 5: Attach the cantilever support arm. Slide the support arm's mounting bracket over the top of the structural column, aligning the three pre-drilled holes with the securing apertures. Do not fully tighten the Phillips-head screws (P-3) yet, as further adjustments will be necessary in Step 7."
        };


        const helpSuggestions = {
            'adventure': [
                "Use high-stakes verbs (e.g., climb, traverse, forge) and action-oriented descriptions.",
                "Focus on the physical setting: harsh terrain, dangerous ruins, or an unknown location.",
                "Establish a clear goal, a ticking clock, or a powerful obstacle the protagonist must overcome.",
                "Describe equipment, skills, or natural resources vital for survival."
            ],
            // ... (Help suggestions remain the same)
            'sci-fi': [
                "Introduce futuristic terminology (e.g., droid, plasma, warp drive) and advanced technology.",
                "Describe the setting with impossible architecture, zero-gravity, or alien landscapes.",
                "Explore a philosophical theme like artificial intelligence, dystopia, or the nature of humanity.",
                "Use precise, technical language when describing equipment or environments."
            ],
            'horror': [
                "Use strong sensory details (damp, stench, shadows) to make the environment feel oppressive.",
                "Build tension gradually; focus on what the protagonist *doesn't* see or know.",
                "Focus on isolation, psychological fear, or a sense of mounting dread.",
                "End the paragraph with a sudden, unsettling reveal or a sound that cuts the silence."
            ],
            'fairy/traditional tale': [
                "Use a familiar opening (e.g., 'Once upon a time', 'In a land far away') or a clear moral lesson.",
                "Introduce magical elements: wishes, curses, spells, or talking animals.",
                "Use archaic or slightly formal language (e.g., hark, verily, bestow).",
                "Establish clear, archetypal characters: the brave hero, the wicked villain, the wise old sage."
            ],
            'comedy': [
                "Use exaggerated descriptions and over-the-top reactions to mundane events.",
                "Employ wordplay, puns, or unexpected juxtapositions of ideas.",
                "Set up a ridiculous situation, a serious misunderstanding, or physical slapstick.",
                "Keep the tone light and the pace brisk."
            ],
            'tragedy': [
                "Focus on emotional inner turmoil, regret, or a moment of inescapable realization.",
                "Foreshadow inevitable doom or disaster using symbolic language (e.g., a cold wind, a failing light).",
                "Use formal or dramatic language and focus on a single, fatal character flaw.",
                "Highlight the gap between the character's desires and reality."
            ],
            'report': [
                "Use objective, formal language and avoid personal opinions or emotional words.",
                "Employ numbered facts, specific dates, or data points.",
                "Maintain a professional, detached tone, and structure sentences clearly and concisely.",
                "Focus on a single topic, providing factual information and analysis."
            ],
            'diary': [
                "Use the first-person perspective ('I', 'my') and conversational, informal language.",
                "Focus on personal feelings, reflections, and internal thoughts about recent events.",
                "Include a date, a time, or a brief sign-off to maintain the format.",
                "The 'voice' should sound spontaneous, as if written quickly after an event."
            ],
            'instructions': [
                "Use clear, commanding verbs (Insert, Twist, Ensure, Connect) at the start of sentences.",
                "Structure the content using ordered steps or phases.",
                "Avoid descriptive language; focus only on the necessary actions and tools.",
                "The goal should be a clear, practical outcome, like building a chair or preparing a meal."
            ]
        };

        const selectElement = document.getElementById('genre-select');
        const generateButton = document.getElementById('generate-button');
        const helpButton = document.getElementById('help-button');
        const outputArea = document.getElementById('output-area');
        const loadingIndicator = document.getElementById('loading-indicator');
        const errorMessage = document.getElementById('error-message');
        const helpModalOverlay = document.getElementById('help-modal-overlay');
        const helpGenreTitle = document.getElementById('help-genre-title');
        const helpSuggestionsList = document.getElementById('help-suggestions-list');

        /**
         * Populates the genre dropdown menu.
         */
        function populateDropdown() {
            Object.keys(genreMap).forEach(key => {
                const option = document.createElement('option');
                option.value = key;
                option.textContent = genreMap[key];
                selectElement.appendChild(option);
            });
        }

        /**
         * Handles genre selection change to enable buttons.
         */
        selectElement.addEventListener('change', () => {
            if (selectElement.value) {
                generateButton.disabled = false;
                helpButton.disabled = false;
            } else {
                generateButton.disabled = true;
                helpButton.disabled = true;
            }
            outputArea.classList.add('italic');
            outputArea.textContent = `Ready to generate a paragraph for the '${genreMap[selectElement.value]}' genre.`;
        });

        /**
         * Displays the help modal with genre-specific suggestions.
         */
        helpButton.addEventListener('click', () => {
            const genreKey = selectElement.value;
            const genreName = genreMap[genreKey];

            helpGenreTitle.textContent = genreName;
            helpSuggestionsList.innerHTML = '';

            const suggestions = helpSuggestions[genreKey] || ["No specific help available for this genre yet."];
            suggestions.forEach(suggestion => {
                const li = document.createElement('li');
                li.textContent = suggestion;
                helpSuggestionsList.appendChild(li);
            });

            helpModalOverlay.classList.add('open');
        });

        /**
         * Shows or hides the loading state.
         */
        function setLoading(isLoading) {
            generateButton.disabled = isLoading || !selectElement.value;
            helpButton.disabled = isLoading || !selectElement.value;
            loadingIndicator.classList.toggle('hidden', !isLoading);
            errorMessage.classList.add('hidden');
            if (isLoading) {
                outputArea.textContent = 'Generating...';
                outputArea.classList.remove('italic');
            }
        }

        /**
         * Fetches a generated paragraph from the Gemini API.
         * @param {string} genre - The selected genre key.
         */
        async function fetchGeneratedParagraph(genre) {
            setLoading(true);
            const genreName = genreMap[genre];
            const systemPrompt = "You are a creative writer focused on specific genre mechanics. Write in British English. Your tone must be appropriate for the requested genre.";
            const userQuery = `Write a single, self-contained paragraph that is between 50 and 100 words long. The paragraph must be written in the style of a **${genreName}** and must end at a compelling or sensible point from which to continue the story or text. The text should be suitable for a high school or secondary school creative writing exercise.`;

            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                systemInstruction: {
                    parts: [{ text: systemPrompt }]
                },
            };

            // Implementation of exponential backoff for API calls
            const maxRetries = 5; // Increased attempts to handle temporary 503 errors
            let lastErrorMessage = 'Failed to connect to the API.';

            for (let attempt = 0; attempt < maxRetries; attempt++) {
                let responseText = null;
                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    // Read response as text first for robust error handling
                    responseText = await response.text();
                    let result = null;

                    if (!response.ok) {
                        try {
                            // Attempt to parse non-200 response body for error message
                            result = JSON.parse(responseText);
                            lastErrorMessage = `API error: ${response.status} - ${result.error?.message || 'Unknown error'}`;
                            throw new Error(lastErrorMessage);
                        } catch (e) {
                            lastErrorMessage = `Server returned error code ${response.status} with unparsable response.`;
                            throw new Error(lastErrorMessage);
                        }
                    }

                    // Attempt to parse the successful response text
                    if (!responseText) {
                         lastErrorMessage = 'Received an empty response body from the model.';
                         throw new Error(lastErrorMessage);
                    }

                    try {
                        result = JSON.parse(responseText);
                    } catch (e) {
                        lastErrorMessage = 'Could not parse model response (malformed JSON).';
                        throw new Error(lastErrorMessage);
                    }
                    
                    const text = result.candidates?.[0]?.content?.parts?.[0]?.text;

                    if (text) {
                        outputArea.textContent = text.trim();
                        outputArea.classList.remove('italic');
                        setLoading(false);
                        return; // Success, exit function
                    } else {
                        lastErrorMessage = 'Model response was valid but contained no generated text.';
                        throw new Error(lastErrorMessage);
                    }

                } catch (error) {
                    // Update error message for the console (last attempt only uses the last message)
                    lastErrorMessage = error.message; 
                    console.error(`Attempt ${attempt + 1} failed:`, error);

                    if (attempt === maxRetries - 1) {
                        // Final failure: Implement fallback mechanism
                        const fallbackText = fallbackParagraphs[genre];
                        
                        if (fallbackText) {
                            console.log(`API failed after ${maxRetries} attempts. Displaying fallback text for ${genreName}.`);
                            outputArea.textContent = `[Service Unavailable - Using Default Text] ${fallbackText}`;
                            outputArea.classList.remove('italic');
                        } else {
                            errorMessage.textContent = `Final failure: Could not generate text and no fallback available. (${lastErrorMessage})`;
                            errorMessage.classList.remove('hidden');
                        }
                        setLoading(false);
                        return; // Final failure, exit function
                    }
                    // Wait before retrying (exponential backoff)
                    await new Promise(resolve => setTimeout(resolve, Math.pow(2, attempt) * 1000));
                }
            }
        }

        /**
         * Event listener for the generate button.
         */
        generateButton.addEventListener('click', () => {
            const selectedGenre = selectElement.value;
            if (selectedGenre) {
                fetchGeneratedParagraph(selectedGenre);
            }
        });

        // Initialize on load
        window.onload = () => {
            populateDropdown();
        };

    </script>
</body>
</html>
