<!DOCTYPE html>
<html lang="en-GB">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ignite Image Spark</title>
    
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Set theme colour -->
    <meta name="theme-color" content="#4f46e5">
    
    <!-- Apple touch icon for iOS -->
    <link rel="apple-touch-icon" href="https://placehold.co/180x180/4f46e5/ffffff?text=Ignite&font=sans">

    <!-- Google Font -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        
        /* Simple loading spinner */
        .spinner {
            width: 48px;
            height: 48px;
            border: 5px solid #FFF;
            border-bottom-color: #4f46e5;
            border-radius: 50%;
            display: inline-block;
            box-sizing: border-box;
            animation: rotation 1s linear infinite;
        }

        @keyframes rotation {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center p-4">

    <div class="bg-white rounded-2xl shadow-xl p-6 sm:p-8 w-full max-w-lg mx-auto">
        
        <!-- Header -->
        <h1 class="text-center text-3xl font-bold text-indigo-700 mb-6">
            Ignite Education
        </h1>

        <!-- Image Container -->
        <div id="image-container" class="w-full h-72 sm:h-80 bg-gray-200 rounded-lg flex items-center justify-center text-gray-500 overflow-hidden mb-6 transition-all duration-300">
            Click the button to spark an idea!
        </div>

        <!-- Words Container -->
        <div id="words-container" class="flex flex-wrap justify-center items-center gap-2 min-h-[3.5rem] mb-6">
            <!-- Word pills will be injected here -->
        </div>

        <!-- Generate Button -->
        <button id="generate-button" class="w-full bg-indigo-600 text-white text-lg font-semibold py-3 px-6 rounded-lg shadow-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 transition-all duration-200 disabled:bg-gray-400 disabled:cursor-not-allowed">
            Spark Image
        </button>
        
    </div>

    <script>
        // --- DOM Elements ---
        const generateButton = document.getElementById('generate-button');
        const imageContainer = document.getElementById('image-container');
        const wordsContainer = document.getElementById('words-container');

        // --- Word Lists ---
        const wordList = [
            'castle', 'forest', 'dragon', 'river', 'mountain', 'ocean', 'city', 'robot', 'planet', 'wizard',
            'key', 'book', 'ship', 'train', 'bridge', 'tower', 'moon', 'star', 'comet', 'garden',
            'island', 'volcano', 'cave', 'desert', 'market', 'library', 'clock', 'mirror', 'door', 'window',
            'ancient', 'mystic', 'silent', 'golden', 'crystal', 'forgotten', 'hidden', 'floating', 'broken',
            'giant', 'tiny', 'bright', 'dark', 'haunted', 'enchanted', 'frozen', 'burning', 'stormy', 'peaceful',
            'red', 'blue', 'green', 'spectral', 'luminous', 'shadowy', 'whispering', 'thundering',
            'sleeps', 'wakes', 'runs', 'jumps', 'flies', 'swims', 'climbs', 'falls', 'grows', 'shrinks',
            'glows', 'fades', 'watches', 'listens', 'speaks', 'sings', 'dances', 'builds', 'explores', 'dreams'
        ];

        // --- Core Functions ---
        function getRandomWords() {
            const shuffled = [...wordList].sort(() => 0.5 - Math.random());
            return shuffled.slice(0, 5);
        }

        function displayWords(words) {
            wordsContainer.innerHTML = '';
            words.forEach(word => {
                const pill = document.createElement('span');
                pill.className = 'bg-indigo-100 text-indigo-800 text-sm font-semibold px-3 py-1 rounded-full';
                pill.textContent = word;
                wordsContainer.appendChild(pill);
            });
        }

        function showLoading() {
            generateButton.disabled = true;
            generateButton.textContent = 'Generating...';
            imageContainer.innerHTML = '<div class="spinner"></div>';
            imageContainer.classList.add('bg-gray-200');
        }

        function hideLoading() {
            generateButton.disabled = false;
            generateButton.textContent = 'Spark New Image';
        }

        /**
         * Fetches an image from the Gemini API based on a prompt.
         * @param {string} prompt - The prompt for image generation.
         * @returns {Promise<string>} A promise that resolves with a base64 image data URL.
         */
        async function generateImage(prompt) {
            
            // --- THIS IS THE FINAL V18 CHANGE ---
            // This URL now points to your new, correct 'poetry-spark-v2' server.
            const apiUrl = "https://poetry-spark-us-958819967973.us-central1.run.app";
            // --- END OF FINAL V18 CHANGE ---
            
            const payload = {
                instances: { 
                    prompt: prompt 
                },
                parameters: { 
                    "sampleCount": 1
                }
            };
            
            let response;
            let retries = 3;
            let delay = 1000;

            for (let i = 0; i < retries; i++) {
                try {
                    response = await fetch(apiUrl, {
                        method: 'POST', 
                        headers: { 
                            'Content-Type': 'application/json',
                            'Accept': 'application/json'
                        },
                        body: JSON.stringify(payload),
                        mode: 'cors'
                    });

                    if (response.ok) {
                        const result = await response.json();
                        if (result.predictions && result.predictions.length > 0 && result.predictions[0].bytesBase64Encoded) {
                            return `data:image/png;base64,${result.predictions[0].bytesBase64Encoded}`;
                        } else {
                            throw new Error('Invalid image data in response.');
                        }
                    } else {
                        const text = await response.text();
                        throw new Error(`API Error: ${response.status} ${response.statusText} - ${text}`);
                    }
                } catch (error) {
                    if (i === retries - 1) { throw error; }
                    await new Promise(res => setTimeout(res, delay));
                    delay *= 2;
                }
            }
            
            throw new Error('Failed to generate image after retries.');
        }

        async function handleGenerateClick() {
            showLoading();
            wordsContainer.innerHTML = ''; 

            try {
                const words = getRandomWords();
                displayWords(words);
                const prompt = `A dream-like, digital art illustration of: ${words.join(', ')}.`;
                const imageUrl = await generateImage(prompt);
                
                imageContainer.innerHTML = '';
                imageContainer.classList.remove('bg-gray-200');
                const img = document.createElement('img');
                img.src = imageUrl;
                img.alt = prompt;
                img.className = 'w-full h-full object-cover';
                imageContainer.appendChild(img);

            } catch (error) {
                console.error('Error generating image:', error);
                imageContainer.innerHTML = `<span class="text-red-500 p-4 text-center">Sorry, an error occurred (${error.message}). Please try again.</span>`;
                imageContainer.classList.add('bg-gray-200');
            } finally {
                hideLoading();
            }
        }

        // --- Event Listener ---
        generateButton.addEventListener('click', handleGenerateClick);

    </script>
</body>
</html>
